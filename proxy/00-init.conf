http {
    map $host $cert_available {
        default "0";
        "~*med5.com.br" "1"; # Só ativa HTTPS para seus domínios
    }

    server {
        listen 80;
        server_name med5.com.br *.med5.com.br;

        location /.well-known/acme-challenge/ {
            root /var/www/html;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # Server block genérico que não quebra sem certificado
    server {
        listen 443 ssl;
        server_name _;
        
        ssl_certificate /etc/letsencrypt/selfsigned.crt;
        ssl_certificate_key /etc/letsencrypt/selfsigned.key;
        
        # Desativa stapling para certificados autoassinados
        ssl_stapling off;
        ssl_stapling_verify off;
                
        # Configuração que só é ativada quando o certificado existir
        if (!-f $ssl_certificate) {
            return 503;
        }

        location / {
            return 404;
        }
    }
}